---  
layout: post  
type: blog  
title: '【PHP 扩展开发】Zephir 简介'  
date: 2019-02-25T09:53:44+08:00  
excerpt: '什么是 Zephir
Zephir 是一种中间语言，以接近 PHP 的语法来编写代码，然后转换编译成 PHP 扩展，旨在简化 PHP 扩展的创建和可维护性。利用编译来提高性能和资源消耗，又不需要关注内'  
key: 0025f4f99f5c41aacbf997834a85a9c2  
---  

**什么是 Zephir**

Zephir 是一种中间语言，以接近 PHP 的语法来编写代码，然后转换编译成 PHP 扩展，旨在简化 PHP 扩展的创建和可维护性。利用编译来提高性能和资源消耗，又不需要关注内存管理等复杂操作。

**安装**

要使用 Zephir 开发 PHP 扩展 ，需要满足以下要求 (以 centos7 + php7.2 为例)

***编译环境***

官方示例以 ubuntu ,需要安装如下扩展

```
sudo apt-get install git gcc make re2c php php-json php-dev libpcre3-dev build-essential
```

我们用 centos ，yum 安装

```
yum install -y git gcc make re2c autoconf automake libtool pcre pcre-devel

yum groupinstall -y "Development Tools"

```

某些库可能某些源没有，可以更换源或者下载源码安装

***php 扩展***

<a>Zephir parser</a> >= 1.1.0

```
wget https://github.com/phalcon/php-zephir-parser/archive/v1.2.0.tar.gz

mv v1.2.0.tar.gz php-zephir-parser-v1.2.0.tar.gz

tar -xvzf php-zephir-parser-v1.2.0.tar.gz

cd php-zephir-parser-1.2.0/

/usr/local/php7/bin/phpize

./configure --with-php-config=/usr/local/php7/bin/php-config

make && make install

```

gmp (PHP 源码中包含该扩展，默认情况下不安装)

扩展安装方法大同小异，不另说明

以源码编译的方式追加安装这两扩展，并配置ini文件

```
extension=gmp.so
extension=zephir_parser.so
```

***安装 Zephir***

Zephir 目前有两个大版本在维护 0.10.X和0.11.X。两个版本差别比较大，我们选择0.11.X，下载最新版本，使用 phar 包

```
cd /usr/local/bin

wget https://github.com/phalcon/zephir/releases/download/0.11.10/zephir.phar

chmod 755 zephir.phar

ln -s /usr/local/bin/zephir.phar zephir

```

***检查是否安装成功***

```
zephir help
```

安装成装显示如下图

![clipboard.png](/blog/files/images/f236f29d00f4915631934e33c10a2864.png "clipboard.png")

**创建扩展**

***初始化一个应用***

```
zephir init first
```

生成如下两个目录和一个文件

![clipboard.png](/blog/files/images/b5b65d54895cbfaf06f88202b0a2e719.png "clipboard.png")

**编写代码**

注意：在 Zephir 中, 每个文件都必须包含一个类 (并且只有一个类)。 每个类都必须有一个命名空间, 并且目录结构必须与所使用的类和命名空间的名称相匹配。

使用 phpstorm 作为 IDE，安装 Zephir 插件。

first\\first\\hello.zep

```
namespace First;

class Hello
{

    public static function world() {
        echo "Hello world!";
    }

    public static function zephir() {
        echo "Hello Zephir!";
    }

}
```

**编译**

```
zephir build
```

第一次执行，运气不好的话会失败。详细日志见 compile-errors.log 文件的内容。

如果 build 成功，会自动生成 first.so 文件到 extension 目录 ,你需要编辑 php.ini 填加扩展

![clipboard.png](/blog/files/images/b362eae5b8de0003085bdfb8fd892fe1.png "clipboard.png")

测试一下

```
<?php

echo First\Hello::world(), "\n";

```

就这样，你也会 PHP 扩展开发了

**附1：Available commands:**

> ```
>     init                Initializes a Zephir extension
>     builddev            Generates/Builds/Installs a Zephir extension in development mode
>     api                 Generates a HTML API based on the classes exposed in the extension
>     clean               Cleans any object files created by the extension
>     generate            Generates C code from the Zephir code without compiling it
>     build               Generates/Builds/Installs a Zephir extension
>     stubs               Generates stubs that can be used in a PHP IDE
>     help                Displays this help and exit
>     fullclean           Cleans any object files created by the extension (including files generated by phpize)
>     compile             Compile a Zephir extension
>     install             Installs the extension in the extension directory (may require root password)
>     version             Shows the Zephir version
> ```